bases:
  - ../environments.yaml
---
repositories:
  - name: argo
    url: https://argoproj.github.io/argo-helm

releases:
  - name: argo-cd
    chart: argo/argo-cd
    namespace: argocd
    values:
      - server:
          ingress:
            enabled: true
            hosts:
              - argocd.{{ .Values.domain }}
            https: true
            annotations:
              traefik.ingress.kubernetes.io/router.entrypoints: websecure
      # https://github.com/lucj/argocd-helmfile-plugin
      - repoServer:
          extraContainers:
            - name: cmp
              command: ["/var/run/argocd/argocd-cmp-server"]
              image: lucj/argocd-plugin-helmfile:v0.0.10
              securityContext:
                runAsNonRoot: true
                runAsUser: 999
              env:
                - name: SOPS_AGE_KEY
                  valueFrom:
                    secretKeyRef:
                      name: age
                      key: privKey
              volumeMounts:
                - mountPath: /var/run/argocd
                  name: var-files
                - mountPath: /home/argocd/cmp-server/plugins
                  name: plugins
  - name: argo-cd-extras
    chart: ../../charts/argo-cd-extras
    namespace: argocd
    values:
      - age:
          privKey: "{{ .Values.age.privKey }}"
  - name: argo-cd-apps
    chart: ../../charts/argo-cd-apps
    namespace: argocd
    values:
      - apps:
          - name: argo-cd
            namespace: argocd
          - name: cnpg
            namespace: cnpg-system
          - name: docker-registry
          - name: gitlab-runner
          - name: kubernetes-dashboard
          - name: longhorn
            namespace: longhorn-system
          - name: traefik
            namespace: kube-system
