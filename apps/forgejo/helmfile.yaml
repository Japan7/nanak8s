environments:
  default:
    values:
      - runners:
          tag: main@sha256:aebfd3d93337f6c03cc0dd6ae1d28d3027ef640e6595bd3663d7ecf4a59138bd # renovate: repository=ghcr.io/japan7/forgejo-runner
    secrets:
      - ../globals.sops.yaml
      - default.sops.yaml
---
repositories:
  - name: forgejo-contrib
    url: codeberg.org/forgejo-contrib
    oci: true

releases:
  - name: forgejo-cnpg
    chart: ../../charts/cnpg-cluster
    values:
      - release: 15
      - storage:
          size: 5Gi
      - user:
          password: "{{ .Values.cnpg.password }}"
      - backups:
          minio:
            endpoint: https://minio.{{ .Values.domain }}
            accessKey: "{{ .Values.cnpg.minio.accessKey }}"
            secretKey: "{{ .Values.cnpg.minio.secretKey }}"
  - name: forgejo
    chart: forgejo-contrib/forgejo
    version: 0.9.0
    values:
      - gitea:
          admin:
            password: "{{ .Values.gitea.adminPassword }}"
          config:
            server:
              ROOT_URL: https://git.{{ .Values.domain }}
              SSH_PORT: 8022
            service:
              REQUIRE_SIGNIN_VIEW: true
              ALLOW_ONLY_EXTERNAL_REGISTRATION: true
            database:
              DB_TYPE: postgres
              HOST: forgejo-cnpg-rw
              NAME: app
              USER: app
              PASSWD: "{{ .Values.cnpg.password }}"
            # https://forgejo.org/2023-02-27-forgejo-actions/
            actions:
              ENABLED: true
              DEFAULT_ACTIONS_URL: https://github.com
      - postgresql:
          enabled: false
      - memcached:
          enabled: false
      - persistence:
          size: 20Gi
      - initPreScript: |
          chmod 600 /data/ssh/*
          chmod 700 /data/git /data/git/.ssh /data/git/.ssh/*
      - affinity:
          nodeAffinity:
            preferredDuringSchedulingIgnoredDuringExecution:
              - weight: 1
                preference:
                  matchExpressions:
                    - key: topology.kubernetes.io/region
                      operator: In
                      values:
                        - eu-west
      - ingress:
          enabled: true
          apiVersion: networking.k8s.io/v1
          hosts:
            - host: git.{{ .Values.domain }}
              paths:
                - path: /
                  pathType: Prefix
          annotations:
            traefik.ingress.kubernetes.io/router.entrypoints: websecure
  - name: forgejo-runner-0
    chart: ../../charts/forgejo-runner
    values:
      - image:
          tag: "{{ .Values.runners.tag }}"
      - secret:
          name: forgejo-runner-0
      - nodeSelector:
          kubernetes.io/arch: amd64
      - dind:
          mtu: 1230
  - name: forgejo-runner-1
    chart: ../../charts/forgejo-runner
    values:
      - image:
          tag: "{{ .Values.runners.tag }}"
      - secret:
          name: forgejo-runner-1
      - nodeSelector:
          kubernetes.io/arch: amd64
      - dind:
          mtu: 1230
  - name: forgejo-extras
    chart: ../../charts/forgejo-extras
    values:
      - registryCredentials:
          registry: git.{{ .Values.domain }}
          username: "{{ .Values.regcreds.username }}"
          password: "{{ .Values.regcreds.password }}"
          namespaces:
            - dakara
            - gitlab
            - nanachan
            - nanapi
            # - strapi
