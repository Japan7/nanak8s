environments:
  default:
    secrets:
      - ../globals.sops.yaml
      - default.sops.yaml
---
repositories:
  - name: forgejo-contrib
    url: codeberg.org/forgejo-contrib
    oci: true
  - name: renovate
    url: https://docs.renovatebot.com/helm-charts

releases:
  - name: forgejo-cnpg-16
    chart: ../../charts/cnpg-cluster
    values:
      - release: 16
      - storage:
          size: 10Gi
      - user:
          password: "{{ .Values.cnpg.password }}"
      - backups:
          minio:
            endpoint: https://minio.{{ .Values.domain }}
            accessKey: "{{ .Values.cnpg.minio.accessKey }}"
            secretKey: "{{ .Values.cnpg.minio.secretKey }}"
  - name: forgejo
    chart: forgejo-contrib/forgejo
    version: 0.15.0
    values:
      - gitea:
          admin:
            password: "{{ .Values.gitea.adminPassword }}"
          config:
            server:
              ROOT_URL: https://git.{{ .Values.domain }}
              SSH_PORT: 8022
              LFS_START_SERVER: true
            service:
              REQUIRE_SIGNIN_VIEW: true
              ALLOW_ONLY_EXTERNAL_REGISTRATION: true
            mailer:
              ENABLED: true
              SMTP_ADDR: "{{ .Values.smtp.host }}"
              SMTP_PORT: 587
              USER: "{{ .Values.smtp.username }}"
              PASSWD: "{{ .Values.smtp.password }}"
              FROM: "{{ .Values.gitea.mailer.from }}"
            database:
              DB_TYPE: postgres
              HOST: forgejo-cnpg-16-rw
              NAME: app
              USER: app
              PASSWD: "{{ .Values.cnpg.password }}"
            cron:
              ENABLED: true
              RUN_AT_START: true
            "cron.delete_old_actions":
              ENABLED: true
              RUN_AT_START: true
            "cron.gc_lfs":
              ENABLED: true
              RUN_AT_START: true
            actions:
              ENABLED: true
              DEFAULT_ACTIONS_URL: https://github.com
      - postgresql:
          enabled: false
      - memcached:
          enabled: false
      - persistence:
          size: 25Gi
          labels:
            recurring-job.longhorn.io/source: enabled
            recurring-job-group.longhorn.io/default: enabled
            recurring-job.longhorn.io/longhorn-backup: enabled
      - affinity:
          podAffinity:
            preferredDuringSchedulingIgnoredDuringExecution:
              - weight: 100
                podAffinityTerm:
                  labelSelector:
                    matchExpressions:
                      - key: cnpg.io/cluster
                        operator: In
                        values:
                          - forgejo-cnpg-16
                      - key: cnpg.io/instanceRole
                        operator: In
                        values:
                          - primary
                  topologyKey: kubernetes.io/hostname
      - ingress:
          enabled: true
          apiVersion: networking.k8s.io/v1
          hosts:
            - host: git.{{ .Values.domain }}
              paths:
                - path: /
                  pathType: Prefix
          annotations:
            traefik.ingress.kubernetes.io/router.entrypoints: websecure
            traefik.ingress.kubernetes.io/router.middlewares: "{{ .Namespace }}-forgejo-cors@kubernetescrd"
  - name: forgejo-runner
    chart: ../../charts/forgejo-runner
    values:
      - instance: http://forgejo-http:3000
      - token: "{{ .Values.runner.token }}"
      - replicaCount: 2
      - nodeSelector:
          kubernetes.io/arch: amd64
      - dind:
          mtu: 1230
          image:
            tag: 24.0.6-dind # FIXME: 24.0.7-dind is broken rn
  - name: renovate
    chart: renovate/renovate
    version: 37.68.4
    values:
      - cronjob:
          schedule: "@hourly"
          concurrencyPolicy: Forbid
          successfulJobsHistoryLimit: 1
      - renovate:
          config: |
            {{ .Values.renovate.config | nindent 12 }}
          configIsSecret: true
      - secrets:
          GITHUB_COM_TOKEN: "{{ .Values.renovate.ghToken }}"
      - env:
          LOG_LEVEL: debug
          LOG_FORMAT: json
  - name: forgejo-extras
    chart: ../../charts/forgejo-extras
    values:
      - imagePrune:
          url: http://forgejo-http:3000
          username: "{{ .Values.imagePrune.username }}"
          password: "{{ .Values.imagePrune.password }}"
      - registryCredentials:
          registry: git.{{ .Values.domain }}
          username: "{{ .Values.regcreds.username }}"
          password: "{{ .Values.regcreds.password }}"
          namespaces:
            - dakara
            - emails
            - nanachan
            - nanapi
            - website
