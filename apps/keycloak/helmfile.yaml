environments:
  default:
    secrets:
      - ../globals.sops.yaml
      - default.sops.yaml
---
releases:
  - name: keycloak-cnpg
    chart: ../../charts/cnpg-cluster
    values:
      - release: 15
      - backups:
          minio:
            accessKey: "{{ .Values.cnpg.minio.accessKey }}"
            secretKey: "{{ .Values.cnpg.minio.secretKey }}"
  - name: keycloak
    chart: oci://registry-1.docker.io/bitnamicharts/keycloak
    version: 13.*
    values:
      - extraStartupArgs: -Dkeycloak.profile.feature.declarative_user_profile=enabled
      - auth:
          adminUser: "{{ .Values.keycloak.admin.username }}"
          existingSecret: admin-secret
          passwordSecretKey: password
      - postgresql:
          enabled: false
      - externalDatabase:
          host: keycloak-cnpg-rw
          database: app
          user: app
          existingSecret: keycloak-cnpg-app
          existingSecretPasswordKey: password
      - service:
          type: ClusterIP
      - ingress:
          enabled: true
          hostname: keycloak.{{ .Values.domain }}
          pathType: Prefix
          annotations:
            traefik.ingress.kubernetes.io/router.entrypoints: websecure
      - extraVolumes:
          - name: keycloak-providers
            emptyDir: {}
      - extraVolumeMounts:
          - name: keycloak-providers
            mountPath: /opt/bitnami/keycloak/providers
      - initContainers:
          - name: add-keycloak-discord
            image: busybox:latest
            command:
              - sh
              - -xc
              - |
                wget -O /providers/keycloak-discord.jar \
                https://github.com/wadahiro/keycloak-discord/releases/download/v0.4.1/keycloak-discord-0.4.1.jar
            volumeMounts:
              - name: keycloak-providers
                mountPath: /providers
  - name: keycloak-extras
    chart: ../../charts/keycloak-extras
    values:
      - admin:
          username: "{{ .Values.keycloak.admin.username }}"
          password: "{{ .Values.keycloak.admin.password }}"
