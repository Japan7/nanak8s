environments:
  default:
    secrets:
      - ../globals.sops.yaml
      - default.sops.yaml
---
repositories:
  - name: bitnami
    url: registry-1.docker.io/bitnamicharts
    oci: true
  - name: goauthentik
    url: https://charts.goauthentik.io

releases:
  - name: authentik-cnpg-16
    chart: ../../charts/cnpg-cluster
    values:
      - release: 16
      - storage:
          size: 5Gi
      - backups:
          enabled: true
          s3: {{ toYaml .Values.cnpg.s3 | nindent 12 }}
  - name: authentik-redis
    chart: bitnami/redis
    version: 19.0.2
    values:
      - architecture: standalone
      - auth:
          enabled: false
      - master:
          persistence:
            size: 1Gi
  - name: authentik
    chart: goauthentik/authentik
    version: 2024.2.2
    values:
      - global:
          env:
            - name: AUTHENTIK_POSTGRESQL__HOST
              valueFrom:
                secretKeyRef:
                  name: authentik-cnpg-16-app
                  key: host
            - name: AUTHENTIK_POSTGRESQL__PORT
              valueFrom:
                secretKeyRef:
                  name: authentik-cnpg-16-app
                  key: port
            - name: AUTHENTIK_POSTGRESQL__NAME
              valueFrom:
                secretKeyRef:
                  name: authentik-cnpg-16-app
                  key: dbname
            - name: AUTHENTIK_POSTGRESQL__USER
              valueFrom:
                secretKeyRef:
                  name: authentik-cnpg-16-app
                  key: username
            - name: AUTHENTIK_POSTGRESQL__PASSWORD
              valueFrom:
                secretKeyRef:
                  name: authentik-cnpg-16-app
                  key: password
      - authentik:
          secret_key: "{{ .Values.authentik.secretKey }}"
          postgresql:
            host: env://AUTHENTIK_POSTGRESQL__HOST
            port: env://AUTHENTIK_POSTGRESQL__PORT
            name: env://AUTHENTIK_POSTGRESQL__NAME
            user: env://AUTHENTIK_POSTGRESQL__USER
            password: env://AUTHENTIK_POSTGRESQL__PASSWORD
          redis:
            host: authentik-redis-master
          email:
            host: "{{ .Values.smtp.host }}"
            username: "{{ .Values.smtp.username }}"
            password: "{{ .Values.smtp.password }}"
            port: 587
            use_ssl: true
            from: "{{ .Values.authentik.smtpFrom }}"
      - server:
          affinity:
            podAffinity:
              preferredDuringSchedulingIgnoredDuringExecution:
                - weight: 100
                  podAffinityTerm:
                    labelSelector:
                      matchExpressions:
                        - key: cnpg.io/cluster
                          operator: In
                          values:
                            - authentik-cnpg-16
                        - key: cnpg.io/instanceRole
                          operator: In
                          values:
                            - primary
                    topologyKey: kubernetes.io/hostname
          ingress:
            enabled: true
            annotations:
              traefik.ingress.kubernetes.io/router.entrypoints: websecure
              cert-manager.io/cluster-issuer: letsencrypt
            hosts:
              - auth.{{ .Values.domain }}
            tls:
              - hosts:
                  - auth.{{ .Values.domain }}
                secretName: auth.{{ .Values.domain }}-tls
