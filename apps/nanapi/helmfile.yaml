environments:
  prod:
    values:
      - tag: 2023.04.01-1
      - dumpsPersistence: true
    secrets:
      - ../globals.sops.yaml
      - prod.sops.yaml
  staging:
    values:
      - tag: sha-eec6da0
      - dumpsPersistence: false
    secrets:
      - ../globals.sops.yaml
      - staging.sops.yaml
  dev:
    values:
      - tag: latest
      - dumpsPersistence: false
    secrets:
      - ../globals.sops.yaml
      - dev.sops.yaml
---
repositories:
  - name: meilisearch
    url: git+https://github.com/meilisearch/meilisearch-kubernetes.git@charts?ref=main
releases:
  - name: nanapi-{{ .Environment.Name }}-meilisearch
    chart: meilisearch/meilisearch
    version: 0
    values:
      - persistence:
          enabled: true
          size: 512Mi
  - name: nanapi-{{ .Environment.Name }}
    chart: ../../charts/nanapi
    values:
      - image:
          repository: git.{{ .Values.domain }}/japan7/nanapi
          tag: "{{ .Values.tag }}"
          pullSecrets:
            - forgejo-regcred
      - dumpsPersistence: !!bool "{{ .Values.dumpsPersistence }}"
      - edgedb:
          service: nanadb.nanadb
          username: "{{ .Values.nanadb.username }}"
          password: "{{ .Values.nanadb.password }}"
          database: nanapi_{{ .Environment.Name }}
      - localSettings: |
          {{ .Values.localSettings | nindent 10 }}
      - ingress:
          host: nanapi.{{ .Values.domain }}
          pathPrefix: "/{{ .Environment.Name }}"
    # FIXME: ugly hack to avoid nanapi scheduling on camp
    # (Illegal instruction (core dumped) crashloop)
    strategicMergePatches:
      - apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: nanapi-{{ .Environment.Name }}
        spec: &patch
          template:
            spec:
              affinity:
                nodeAffinity:
                  requiredDuringSchedulingIgnoredDuringExecution:
                    nodeSelectorTerms:
                      - matchExpressions:
                          - key: kubernetes.io/hostname
                            operator: NotIn
                            values:
                              - camp
      - apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: nanapi-{{ .Environment.Name }}-tasks
        spec: *patch
