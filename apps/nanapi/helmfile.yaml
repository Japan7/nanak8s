environments:
  prod:
    values:
      - tag: 2023.04.19
    secrets:
      - ../globals.sops.yaml
      - prod.sops.yaml
  staging:
    values:
      - tag: sha-99895e5
    secrets:
      - ../globals.sops.yaml
      - staging.sops.yaml
  dev:
    values:
      - tag: latest
    secrets:
      - ../globals.sops.yaml
      - dev.sops.yaml
---
repositories:
  - name: meilisearch
    url: https://meilisearch.github.io/meilisearch-kubernetes
releases:
  - name: nanapi-{{ .Environment.Name }}-meilisearch
    chart: meilisearch/meilisearch
    version: 0.1
    values:
      - persistence:
          enabled: true
          size: 512Mi
  - name: nanapi-{{ .Environment.Name }}
    chart: ../../charts/nanapi
    values:
      - image:
          repository: git.{{ .Values.domain }}/japan7/nanapi
          tag: "{{ .Values.tag }}"
          pullSecrets:
            - forgejo-regcred
      - edgedb:
          service: nanadb.nanadb
          username: "{{ .Values.nanadb.username }}"
          password: "{{ .Values.nanadb.password }}"
          database: nanapi_{{ .Environment.Name }}
      - localSettings: |
          {{ .Values.localSettings | nindent 10 }}
      - tasks:
          enabled: !!bool '{{ eq .Environment.Name "prod" }}'
      - ingress:
          host: nanapi.{{ .Values.domain }}
          pathPrefix: "/{{ .Environment.Name }}"
