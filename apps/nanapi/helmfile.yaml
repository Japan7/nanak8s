bases:
  - environments.yaml
---
repositories:
  - name: meilisearch
    url: https://meilisearch.github.io/meilisearch-kubernetes

releases:
  - name: nanapi-{{ .Environment.Name }}-meilisearch
    chart: meilisearch/meilisearch
    version: 0.1.50 # upgrade is a pain
    values:
      - persistence:
          enabled: true
          size: 512Mi
      - affinity: {{ toYaml .Values.affinity | nindent 10 }}
  - name: nanapi-{{ .Environment.Name }}
    chart: ../../charts/nanapi
    values:
      - image:
          repository: git.{{ .Values.domain }}/japan7/nanapi
          tag: "{{ .Values.tag }}"
          pullSecrets:
            - forgejo-regcred
      - edgedb:
          service: nanadb.nanadb
          username: "{{ .Values.nanadb.username }}"
          password: "{{ .Values.nanadb.password }}"
          database: nanapi_{{ .Environment.Name }}
      - localSettings: |
          {{ .Values.localSettings | nindent 10 }}
      - tasks:
          enabled: {{ .Values.tasks }}
      - dumps:
          enabled: {{ .Values.dumps }}
      - affinity: {{ toYaml .Values.affinity | nindent 10 }}
      - ingress:
          host: nanapi.{{ .Values.domain }}
          pathPrefix: "/{{ .Environment.Name }}"
