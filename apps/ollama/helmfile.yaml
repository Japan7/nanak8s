environments:
  default:
    secrets:
      - ../globals.sops.yaml
---
repositories:
  - name: ollama-helm
    url: https://otwld.github.io/ollama-helm
  - name: open-webui
    url: git+https://github.com/open-webui/open-webui@kubernetes/helm?ref=v0.1.118 # renovate

releases:
  - name: ollama
    chart: ollama-helm/ollama
    version: 0.22.0
    values:
      - ollama:
          models:
            - mistral
      - nodeSelector:
          kubernetes.io/hostname: gungnir
      - persistentVolume:
          enabled: false
  - name: open-webui
    chart: open-webui/open-webui
    values:
      - ollama:
          externalHost: http://ollama:11434
      - webui:
          nodeSelector:
            kubernetes.io/hostname: gungnir
          persistence:
            size: 1Gi
          ingress:
            enabled: true
            host: chat.{{ .Values.domain }}
            annotations:
              traefik.ingress.kubernetes.io/router.entrypoints: websecure
              traefik.ingress.kubernetes.io/router.middlewares: nanaoidc-nanaoidc@kubernetescrd
              cert-manager.io/cluster-issuer: letsencrypt
            tls: true
            existingSecret: chat.{{ .Values.domain }}-tls
    strategicMergePatches:
      - apiVersion: v1
        kind: PersistentVolumeClaim
        metadata:
          name: open-webui
          labels:
            recurring-job.longhorn.io/source: enabled
            recurring-job-group.longhorn.io/default: enabled
            recurring-job.longhorn.io/longhorn-backup: enabled
