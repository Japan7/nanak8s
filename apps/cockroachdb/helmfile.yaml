environments:
  default:
    secrets:
      - ../globals.sops.yaml
---
repositories:
  - name: cockroachdb
    url: https://charts.cockroachdb.com/

releases:
  - name: cockroachdb
    chart: cockroachdb/cockroachdb
    version: 10
    values:
      - conf:
          cluster-name: nanak8s
      - storage:
          persistentVolume:
            storageClass: longhorn-single
            size: 10Gi
      # https://github.com/cockroachdb/helm-charts/issues/149
      - init:
          jobAnnotations:
            argocd.argoproj.io/hook: Sync
      # FIXME: https://github.com/cockroachdb/helm-charts/issues/228
      - tls:
          enabled: false
      - nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 1
              preference:
                matchExpressions:
                  - key: topology.kubernetes.io/region
                    operator: In
                    values:
                      - eu-west
      - ingress:
          enabled: true
          annotations:
            traefik.ingress.kubernetes.io/router.entrypoints: websecure
            traefik.ingress.kubernetes.io/router.middlewares: kube-system-traefik-forward-auth-nanak8s@kubernetescrd
          hosts:
            - crdb.{{ .Values.domain }}
      - serviceMonitor:
          enabled: true
