environments:
  default:
    secrets:
      - ../globals.sops.yaml
---
repositories:
  - name: bitnami
    url: https://charts.bitnami.com/bitnami
  - name: fluent
    url: https://fluent.github.io/helm-charts

releases:
  - name: elasticsearch
    chart: bitnami/elasticsearch
    values:
      - global:
          kibanaEnabled: true
      - master:
          replicaCount: 3
          persistence:
            storageClass: longhorn-elasticsearch
            size: 2Gi
      - data:
          replicaCount: 0
      - coordinating:
          replicaCount: 0
      - kibana:
          persistence:
            size: 1Gi
          ingress:
            enabled: true
            hostname: kibana.{{ .Values.domain }}
            pathType: Prefix
            path: /
            annotations:
              traefik.ingress.kubernetes.io/router.entrypoints: websecure
  - name: fluentd
    chart: fluent/fluentd
    values:
      - env:
          - name: FLUENTD_CONF
            value: "../../../etc/fluent/fluent.conf"
          - name: FLUENT_ELASTICSEARCH_HOST
            value: "elasticsearch"
          - name: FLUENT_ELASTICSEARCH_PORT
            value: "9200"
      - podSecurityPolicy:
          enabled: false
