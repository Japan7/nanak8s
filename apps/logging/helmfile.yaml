environments:
  default:
    secrets:
      - ../globals.sops.yaml
---
repositories:
  - name: bitnami
    url: https://charts.bitnami.com/bitnami
  - name: fluent
    url: https://fluent.github.io/helm-charts

releases:
  - name: elasticsearch
    chart: bitnami/elasticsearch
    values:
      - master:
          replicaCount: 3
          persistence:
            storageClass: longhorn-elasticsearch
            size: 2Gi
      - data:
          replicaCount: 0
      - coordinating:
          replicaCount: 0
      - ingest:
          enabled: false
  - name: fluentd
    chart: fluent/fluentd
    values:
      - env:
          - name: FLUENT_ELASTICSEARCH_HOST
            value: elasticsearch-master-hl
          - name: FLUENT_ELASTICSEARCH_PORT
            value: 9200
      - podSecurityPolicy:
          enabled: false
  - name: kibana
    chart: bitnami/kibana
    values:
      - elasticsearch:
          hosts:
            - elasticsearch-master-hl
          port: 9200
      - extraConfiguration:
          server:
            publicBaseUrl: http://kibana.{{ .Values.domain }}
      - persistence:
          accessModes:
            - ReadWriteMany
          size: 1Gi
      - ingress:
          enabled: true
          hostname: kibana.{{ .Values.domain }}
          pathType: Prefix
          path: /
          annotations:
            traefik.ingress.kubernetes.io/router.entrypoints: websecure
