environments:
  default:
    secrets:
      - ../globals.sops.yaml
      - default.sops.yaml
---
repositories:
  - name: onlyoffice
    url: https://download.onlyoffice.com/charts/stable
  - name: bitnami
    url: https://charts.bitnami.com/bitnami

releases:
  - name: documentserver-cnpg
    chart: ../../charts/cnpg-cluster
    values:
      - release: 15
      - minio:
          accessKey: "{{ .Values.cnpg.minio.accessKey }}"
          secretKey: "{{ .Values.cnpg.minio.secretKey }}"
  - name: documentserver-redis
    chart: bitnami/redis
    version: 17
    values:
      - architecture: standalone
      - auth:
          enabled: false
      - master:
          persistence:
            size: 1Gi
  - name: documentserver-rabbitmq
    chart: bitnami/rabbitmq
    version: 11
    values:
      - auth:
          password: "{{ .Values.rabbitmq.password }}"
          erlangCookie: "{{ .Values.rabbitmq.erlangCookie }}"
      - persistence:
          size: 1Gi
      # FIXME: ulimit: open files: cannot modify limit: Operation not permitted
      - affinity:
          nodeAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              nodeSelectorTerms:
                - matchExpressions:
                    - key: kubernetes.io/hostname
                      operator: NotIn
                      values:
                        - gungnir
  - name: documentserver
    chart: onlyoffice/docs
    version: 3
    values:
      - connections:
          dbHost: documentserver-cnpg-rw
          dbUser: superuser
          dbExistingSecret: documentserver-cnpg-superuser
          dbSecretKeyName: password
          redisHost: documentserver-redis-master
          redisNoPass: true
          amqpHost: documentserver-rabbitmq
          amqpExistingSecret: documentserver-rabbitmq
      - persistence:
          storageClass: longhorn
          size: 1Gi
      - docservice:
          image:
            repository: onlyoffice/docs-docservice
      - proxy:
          image:
            repository: onlyoffice/docs-proxy
      - converter:
          image:
            repository: onlyoffice/docs-converter
      - ingress:
          enabled: true
          annotations:
            traefik.ingress.kubernetes.io/router.entrypoints: websecure
          host: onlyoffice.{{ .Values.domain }}
      # https://github.com/ONLYOFFICE/Kubernetes-Docs/issues/171#issuecomment-1191447111
      - install:
          job:
            enabled: false
      - upgrade:
          job:
            enabled: true
