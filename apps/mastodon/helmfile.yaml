environments:
  default:
    secrets:
      - ../globals.sops.yaml
      - default.sops.yaml
---
repositories:
  - name: bitnamicharts
    url: registry-1.docker.io/bitnamicharts
    oci: true
  - name: opensearch
    url: https://opensearch-project.github.io/helm-charts/

releases:
  - name: mastodon-cnpg
    chart: ../../charts/cnpg-cluster
    values:
      - release: 15
      - backups:
          minio:
            endpoint: https://minio.{{ .Values.domain }}
            accessKey: "{{ .Values.cnpg.minio.accessKey }}"
            secretKey: "{{ .Values.cnpg.minio.secretKey }}"
  - name: mastodon-opensearch
    chart: opensearch/opensearch
    version: 2.13.3
    values:
      - singleNode: true
      - extraEnvs:
          - name: DISABLE_INSTALL_DEMO_CONFIG
            value: "true"
          - name: DISABLE_SECURITY_PLUGIN
            value: "true"
      - persistence:
          size: 1Gi
  - name: mastodon
    chart: bitnamicharts/mastodon
    version: 1.5.8
    values:
      - postgresql:
          enabled: false
      - externalDatabase:
          host: mastodon-cnpg-rw
          user: app
          database: app
          existingSecret: mastodon-cnpg-app
          existingSecretPasswordKey: password
      - redis:
          auth:
            enabled: false
          master:
            persistence:
              size: 1Gi
      - minio:
          enabled: false
      - externalS3:
          host: minio.{{ .Values.domain }}
          accessKeyID: "{{ .Values.minio.accessKey }}"
          accessKeySecret: "{{ .Values.minio.secretKey }}"
          bucket: mastodon
      - elasticsearch:
          enabled: false
      - externalElasticsearch:
          host: opensearch-cluster-master
          port: 9200
      - adminUser: "{{ .Values.admin.username }}"
      - adminEmail: "{{ .Values.admin.email }}"
      - adminPassword: "{{ .Values.admin.password }}"
      - localDomain: "{{ .Values.domain }}"
      - webDomain: mastodon.{{ .Values.domain }}
      - extraConfig:
          LIMITED_FEDERATION_MODE: "true"
      - smtp:
          server: "{{ .Values.smtp.host }}"
          from_address: "{{ .Values.smtp.from }}"
          login: "{{ .Values.smtp.username }}"
          password: "{{ .Values.smtp.password }}"
      - apache:
          service:
            type: ClusterIP
          ingress:
            enabled: true
            hostname: mastodon.{{ .Values.domain }}
            annotations:
              traefik.ingress.kubernetes.io/router.entrypoints: websecure
