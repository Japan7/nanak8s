environments:
  default:
    secrets:
      - secrets.yaml
---
repositories:
  - name: kubernetes-dashboard
    url: https://kubernetes.github.io/dashboard/
  - name: longhorn
    url: https://charts.longhorn.io
  - name: cnpg
    url: https://cloudnative-pg.github.io/charts
  - name: argo
    url: https://argoproj.github.io/argo-helm
  - name: twuni
    url: https://helm.twun.io

releases:
  - name: base
    chart: charts/base
    namespace: base
    values:
      - domain: "{{ .Values.domain }}"
      - traefik:
          letsencryptEmail: "{{ .Values.traefik.letsencryptEmail }}"
      - japan7BasicAuth:
          username: "{{ .Values.japan7BasicAuth.username }}"
          password: "{{ .Values.japan7BasicAuth.password }}"
      - age:
          key: "{{ .Values.age.key }}"
  - name: kubernetes-dashboard
    chart: kubernetes-dashboard/kubernetes-dashboard
    namespace: kubernetes-dashboard
    values:
      - metricsScraper:
          enabled: true
      - ingress:
          enabled: true
          hosts:
            - dashboard.{{ .Values.domain }}
          annotations:
            traefik.ingress.kubernetes.io/router.entrypoints: websecure
  - name: longhorn
    chart: longhorn/longhorn
    namespace: longhorn-system
    values:
      - ingress:
          enabled: true
          host: longhorn.{{ .Values.domain }}
          annotations:
            traefik.ingress.kubernetes.io/router.entrypoints: websecure
  - name: cnpg
    chart: cnpg/cloudnative-pg
    namespace: cnpg-system
  - name: argo-cd
    chart: argo/argo-cd
    namespace: argocd
    values:
      - server:
          ingress:
            enabled: true
            hosts:
              - argocd.{{ .Values.domain }}
            https: true
            annotations:
              traefik.ingress.kubernetes.io/router.entrypoints: websecure
      # https://github.com/lucj/argocd-helmfile-plugin
      - repoServer:
          volumes:
            - name: age
              secret:
                secretName: age
          extraContainers:
            - name: cmp
              command: ["/var/run/argocd/argocd-cmp-server"]
              image: lucj/argocd-plugin-helmfile:v0.0.10
              securityContext:
                runAsNonRoot: true
                runAsUser: 999
              env:
                - name: SOPS_AGE_KEY_FILE
                  value: /app/config/age/key.txt
              volumeMounts:
                - mountPath: /app/config/age/
                  name: age
                - mountPath: /var/run/argocd
                  name: var-files
                - mountPath: /home/argocd/cmp-server/plugins
                  name: plugins
  - name: docker-registry
    chart: twuni/docker-registry
    namespace: docker-registry
    values:
      - persistence:
          enabled: true
      - secrets:
          haSharedSecret: "{{ .Values.dockerRegistry.haSharedSecret }}"
      - ingress:
          enabled: true
          hosts:
            - registry.{{ .Values.domain }}
          className:
          annotations:
            traefik.ingress.kubernetes.io/router.entrypoints: websecure
