apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: patch-coredns-configmap
spec:
  rules:
    - name: patch-coredns-configmap
      match:
        resources:
          kinds:
            - ConfigMap
        namespaces:
          values:
            - "{{ .Release.Namespace }}"
        name:
          pattern: coredns
      mutate:
        patchStrategicMerge:
          data:
            Corefile: |
              .:53 {
                  errors
                  health
                  ready
                  kubernetes cluster.local in-addr.arpa ip6.arpa {
                    pods insecure
                    fallthrough in-addr.arpa ip6.arpa
                  }
                  hosts /etc/coredns/NodeHosts {
                    ttl 60
                    reload 15s
                    fallthrough
                  }
                  prometheus :9153
                  forward . {{ .Values.coredns.dnsServers }}
                  cache 30
                  loop
                  reload
                  loadbalance
              }
              import /etc/coredns/custom/*.server
