{{- if .Values.dumps.enabled }}
kind: ConfigMap
apiVersion: v1
metadata:
  name: "{{ .Release.Name }}-dumps"
  labels:
    {{- include "common.labels.standard" . | nindent 4 }}
    app.kubernetes.io/component: dumps
    app.kubernetes.io/part-of: {{ .Chart.Name }}
data:
  dump.sh: |
    #!/bin/sh -xe

    apk add curl
    curl --proto '=https' --tlsv1.2 -sSf https://sh.edgedb.com | sh -s -- -y
    . ~/.config/edgedb/env

    cd /dumps/
    DUMP_NAME=$(date +%Y-%m-%d_%H-%M-%S).dump
    edgedb dump $DUMP_NAME
    ls *.dump | grep -v $DUMP_NAME | xargs rm -f
{{- end }}
